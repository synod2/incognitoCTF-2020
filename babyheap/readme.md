babyheap
--------
```
Ubuntu GLIBC 2.27-3ubuntu1 -> 18.04
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : ENABLED
RELRO     : FULL
```
2.27 문제면 대부분이 tcache 관련이더라. 
일단 메뉴는 생성,삭제,수정,보기가 있고
삭제하더라도 보기와 수정은 가능하다. 

삭제시에 전체가 비어있으면 중복 삭제는 불가능해보임. 
최대 9개까지 할당 가능하고, 할당할때마다 갯수 카운터가 1씩 증가한다. 

삭제는 맨 끝에 하나만 하는것 처럼 보이는데, 갯수를 나타내는 카운터가 있어
삭제하면 카운터 숫자가 하나씩 감소한다. 

보기시에 삭제한 힙을 볼수 없는건 단순하게 해당 위치 값이 바뀌기 때문
해당 구조체 배열은 청크 크기와 주소값을 가지고 있음. 

그러므로 둘 이상을 삭제한 다음 show를 하면 간단하게 힙 주소 릭이 가능함. 
크기에 대한 제한도 없어보이므로 7번 할당 해제를 진행하여 unsortbin에 위치시키면
libc 릭도 가능해보임. 

? 이럼 끝난거 아닌가? libc 주소를 가져올 수 있고, 할당 해제된 청크의 값도 조작이 가능하다. 
가장 마지막에 할당해제한 청크의 fd를 덮어씌우고 재 할당을 진행해보자.

프리 훅까지는 덮어썼는데, 원샷가젯 사용이 막힌다. 
일단 지금은 특정 주소영역에 할당이 가능하다. free가 안되니 malloc으로 재시도.. 또한 실패.

이러면 구조체 배열을 덮어써서 bin/sh를 쓰는쪽으로 가자.
근데 힙주소를 기반으로 전역변수 주소값을 찾아올 수 있었나?

free 할때를 잘 생각하자. 
구조체 배열에서 해당 인덱스 힙 주소 가져와서 free를 진행하는데, 
구조체 배열에 저장되는 주소는 할당에 성공한 힙 주소를 가져와 저장한다. 
그리고 free 진행시엔 힙 주소를 인자로 하여 free를 진행한다. 
즉, free 함수가 system 으로 바뀔 경우, 전달되는 인자는 /bin/sh의 주소값을 가지고 있어도 된다는것. 

그렇다면 해당 구조체 위치의 주소값이 bin/sh 문자열을 가리키고 있어야 한다. 

복잡하게 생각할 거 없이 힙에 bin/sh를 써주면 되는것. 
다른 크기 미리 해제 시켜놓고, 힙을 새로 할당하면서 bin/sh를 써주자. 





